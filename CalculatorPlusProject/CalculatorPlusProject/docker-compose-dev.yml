version: "3.8"
services:
  # Maven build e run
  maven:
    image: maven:3.8.6-openjdk-11
    container_name: calc-app
    working_dir: /app
    volumes:
      - .:/app
      - ~/.m2:/root/.m2
      - maven-target:/app/target # Volume separado para target
    ports:
      - "8090:9000" # Mapeia 9000 do container para 8090 do host
    # command: sh -lc "mvn -q -DskipTests -Dspring-boot.run.profiles=prod spring-boot:run"
    command: sh -lc "mvn -q -DskipTests -Dspring-boot.run.profiles=default spring-boot:run"
    networks:
      - app-network
    environment:
      - SERVER_PORT=9000
      # Desativa SystemMetricsAutoConfiguration para evitar NPE em ProcessorMetrics
      - SPRING_AUTOCONFIGURE_EXCLUDE=org.springframework.boot.actuate.autoconfigure.metrics.SystemMetricsAutoConfiguration,org.springframework.boot.actuate.autoconfigure.metrics.web.tomcat.TomcatMetricsAutoConfiguration

  # Servi√ßo para rodar testes sob demanda
  tests:
    image: maven:3.8.6-openjdk-11
    working_dir: /app
    profiles:
      - tests
    volumes:
      - .:/app
      - ~/.m2:/root/.m2
      - maven-target:/app/target
    networks:
      - app-network
    environment:
      - SPRING_PROFILES_ACTIVE=test
      - SPRING_AUTOCONFIGURE_EXCLUDE=org.springframework.boot.actuate.autoconfigure.metrics.SystemMetricsAutoConfiguration,org.springframework.boot.actuate.autoconfigure.metrics.web.tomcat.TomcatMetricsAutoConfiguration
    command: sh -lc "mvn -q test"

networks:
  app-network:
    driver: bridge

volumes:
  maven-target:
